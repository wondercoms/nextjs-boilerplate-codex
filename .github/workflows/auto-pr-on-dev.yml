name: Auto PR on DEV branches

on:
  push:
    branches:
      - 'DEV-*'
      - 'feat/DEV-*'
      - 'fix/DEV-*'
      - '**/DEV-*'     # æ·±ã„éšå±¤ã®ãƒ–ãƒ©ãƒ³ãƒåã«ã‚‚å¯¾å¿œ
  workflow_dispatch: {} # æ‰‹å‹•å®Ÿè¡Œãƒ†ã‚¹ãƒˆç”¨

permissions:
  contents: write
  pull-requests: write

jobs:
  create-pr:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set base & extract vars
        run: |
          echo "BRANCH=${GITHUB_REF_NAME}" >> $GITHUB_ENV
          echo "BASE=${{ github.event.repository.default_branch }}" >> $GITHUB_ENV
          ISSUE_KEY=$(echo "${GITHUB_REF_NAME}" | grep -oE 'DEV-[0-9]+' || true)
          echo "ISSUE_KEY=${ISSUE_KEY}" >> $GITHUB_ENV

      - name: Ensure PR exists (create or reuse)
        id: pr
        uses: actions/github-script@v7
        with:
          github-token: ${{ github.token }}
          script: |
            const { owner, repo } = context.repo;
            const branch   = process.env.BRANCH;
            const base     = process.env.BASE || context.payload.repository.default_branch;
            const issueKey = process.env.ISSUE_KEY || branch;
            const title    = `${issueKey}: auto PR`;
            const body     = `Backlog: https://wondercoms.backlog.com/view/${issueKey}\n\nå¤‰æ›´ç‚¹:\n- å©ãå°PR`;

            // æ—¢å­˜ Open PR ã‚’å†åˆ©ç”¨
            const openPrs = await github.paginate(github.rest.pulls.list, {
              owner, repo, state: 'open', head: `${owner}:${branch}`, base, per_page: 100
            });
            if (openPrs.length) { core.setOutput('url', openPrs[0].html_url); return; }

            // é–‰ã˜ãŸ PR ãŒã‚ã‚Œã°å†ã‚ªãƒ¼ãƒ—ãƒ³
            const closedPrs = await github.paginate(github.rest.pulls.list, {
              owner, repo, state: 'closed', head: `${owner}:${branch}`, base, per_page: 100
            });
            if (closedPrs.length) {
              const reopened = await github.rest.pulls.update({
                owner, repo, pull_number: closedPrs[0].number, state: 'open'
              });
              core.setOutput('url', reopened.data.html_url); return;
            }

            // æ–°è¦ PR ã‚’ä½œæˆ
            const pr = await github.rest.pulls.create({ owner, repo, title, head: branch, base, body });
            core.setOutput('url', pr.data.html_url);

      - name: Echo PR URL
        run: echo "PR URL = ${{ steps.pr.outputs.url }}"

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # Backlog ãƒ‡ãƒãƒƒã‚°ï¼ˆåŸå› åˆ‡ã‚Šåˆ†ã‘ï¼‰
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Debug Backlog credentials (temporary)
        if: env.ISSUE_KEY != ''
        env:
          BACKLOG_DOMAIN: ${{ secrets.BACKLOG_DOMAIN }}   # ä¾‹: wondercoms.backlog.comï¼ˆhttps://ä¸è¦ï¼‰
          BACKLOG_API_KEY: ${{ secrets.BACKLOG_API_KEY }} # å€‹äººAPIã‚­ãƒ¼ï¼ˆèª²é¡Œã«ã‚³ãƒ¡ãƒ³ãƒˆæ¨©é™ã®ã‚ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼‰
        run: |
          set -euo pipefail
          # ãƒ‰ãƒ¡ã‚¤ãƒ³æ•´å½¢ï¼ˆhttps://é™¤å»ãƒ»æœ«å°¾ã‚¹ãƒ©å‰Šé™¤ãƒ»ç©ºç™½æ”¹è¡Œé™¤å»ï¼‰
          DOMAIN="$(echo -n "$BACKLOG_DOMAIN" | sed -e 's#^https\?://##' -e 's#/*$##' | tr -d ' \r\n')"
          KEY="$(echo -n "$BACKLOG_API_KEY" | tr -d ' \r\n')"
          echo "DOMAIN=${DOMAIN}"
          echo "ISSUE=${ISSUE_KEY}"

          echo "ğŸ” /users/myself ã§èªè¨¼ç¢ºèªä¸­..."
          HTTP=$(curl -s -o /tmp/me.json -w '%{http_code}' "https://${DOMAIN}/api/v2/users/myself?apiKey=${KEY}" || true)
          echo "HTTP=${HTTP}"
          if [ "$HTTP" != "200" ]; then
            echo "âŒ Backlog èªè¨¼å¤±æ•—ã€‚ãƒ¬ã‚¹ãƒãƒ³ã‚¹:"
            cat /tmp/me.json || true
            exit 1
          fi
          echo "âœ… Auth OK"

          echo "ğŸ” /issues/${ISSUE_KEY} ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹æ¨©ç¢ºèªä¸­..."
          IHTTP=$(curl -s -o /tmp/issue.json -w '%{http_code}' "https://${DOMAIN}/api/v2/issues/${ISSUE_KEY}?apiKey=${KEY}" || true)
          echo "HTTP=${IHTTP}"
          if [ "$IHTTP" != "200" ]; then
            echo "âš ï¸ èª²é¡Œã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã§200ä»¥å¤–ã€‚ã‚³ãƒ¡ãƒ³ãƒˆæ¨©é™ã‚„ã‚­ãƒ¼ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ‰€å±ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚ãƒ¬ã‚¹ãƒãƒ³ã‚¹:"
            cat /tmp/issue.json || true
            # ã“ã“ã§ã¯å¤±æ•—ã«ã—ãªã„ï¼ˆã‚³ãƒ¡ãƒ³ãƒˆStepã§å†åº¦ã‚¨ãƒ©ãƒ¼å‡ºåŠ›ï¼‰
          fi

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # Backlog ã« PR URL ã‚’ã‚³ãƒ¡ãƒ³ãƒˆï¼ˆæœ¬ç•ªï¼‰
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Comment PR URL to Backlog
        if: env.ISSUE_KEY != '' && steps.pr.outputs.url != ''
        env:
          BACKLOG_DOMAIN: ${{ secrets.BACKLOG_DOMAIN }}
          BACKLOG_API_KEY: ${{ secrets.BACKLOG_API_KEY }}
        run: |
          set -euo pipefail
          DOMAIN="$(echo -n "$BACKLOG_DOMAIN" | sed -e 's#^https\?://##' -e 's#/*$##' | tr -d ' \r\n')"
          KEY="$(echo -n "$BACKLOG_API_KEY" | tr -d ' \r\n')"
          ISSUE="${ISSUE_KEY}"
          PR_URL='${{ steps.pr.outputs.url }}'

          echo "ğŸ“ Backlog ã‚³ãƒ¡ãƒ³ãƒˆæŠ•ç¨¿: issue=${ISSUE}"
          # èªè¨¼å†ç¢ºèªï¼ˆã“ã“ã§å¤±æ•—ã•ã›ã¦è©³ç´°ãƒ­ã‚°ã‚’æ®‹ã™ï¼‰
          curl -fsS "https://${DOMAIN}/api/v2/users/myself?apiKey=${KEY}" >/dev/null

          # ã‚³ãƒ¡ãƒ³ãƒˆæŠ•ç¨¿ï¼šHTTPã‚³ãƒ¼ãƒ‰ã‚’å–å¾—ï¼ˆ200/201ã‚’æˆåŠŸæ‰±ã„ï¼‰
          STATUS="$(curl -sS -o /tmp/backlog_comment.json -w '%{http_code}' -X POST \
            "https://${DOMAIN}/api/v2/issues/${ISSUE}/comments?apiKey=${KEY}" \
            --data-urlencode "content=è‡ªå‹•ç”ŸæˆPR: ${PR_URL}")"

          echo "Response body:"; cat /tmp/backlog_comment.json || true
          echo "HTTP=${STATUS}"

          if [ "$STATUS" = "200" ] || [ "$STATUS" = "201" ]; then
            echo "âœ… Backlog ${ISSUE} ã«ã‚³ãƒ¡ãƒ³ãƒˆã—ã¾ã—ãŸ"
          else
            echo "âŒ Backlog ã‚³ãƒ¡ãƒ³ãƒˆå¤±æ•—ï¼ˆHTTP=${STATUS}ï¼‰"
            exit 1
          fi